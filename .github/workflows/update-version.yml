name: Update Version File
on:
  push:
    paths:
      - 'svg/**/*.svg'
      - 'templates/**/*.html'
      - 'app2.py'
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Create version.json
        run: |
          python -c "
          import os
          import json
          import hashlib

          def calculate_file_hash(filepath):
              sha256_hash = hashlib.sha256()
              with open(filepath, 'rb') as f:
                  for byte_block in iter(lambda: f.read(4096), b''):
                      sha256_hash.update(byte_block)
              return sha256_hash.hexdigest()

          version_data = {}

          # SVG 파일 처리
          svg_dir = 'svg'
          if os.path.exists(svg_dir):
              for filename in os.listdir(svg_dir):
                  if filename.endswith('.svg'):
                      filepath = os.path.join(svg_dir, filename)
                      version_data[filename] = calculate_file_hash(filepath)

          # Templates 파일 처리
          templates_dir = 'templates'
          if os.path.exists(templates_dir):
              for filename in os.listdir(templates_dir):
                  if filename.endswith('.html'):
                      filepath = os.path.join(templates_dir, filename)
                      # templates/ 접두사를 추가하여 키 생성
                      version_data[f'templates/{filename}'] = calculate_file_hash(filepath)

          # app2.py (서버 스크립트) 처리 — exe launcher가 GitHub에서 받아 실행하는 파일
          if os.path.exists('app2.py'):
              version_data['app2.py'] = calculate_file_hash('app2.py')

          with open('version.json', 'w') as f:
              json.dump(version_data, f, indent=2, ensure_ascii=False)
          "

      - name: Commit and push if changed
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add version.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Update version.json"
          git push
